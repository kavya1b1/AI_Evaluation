import streamlit as st
import requests
import time
import plotly.graph_objects as go

# ------------------ Page Config ------------------
st.set_page_config(
    page_title="AI Proposal Evaluation System",
    layout="centered"
)

st.title("ğŸ¤– AI Proposal Evaluation System")
st.caption("Machine Learning + NLP + Generative AIâ€“based Proposal Assessment")

# ------------------ Inputs ------------------
file = st.file_uploader("ğŸ“„ Upload Proposal PDF", type=["pdf"])
budget = st.number_input(
    "ğŸ’° Proposed Budget (â‚¹)",
    min_value=0.0,
    step=10000.0
)

# ------------------ Session State ------------------
if "result" not in st.session_state:
    st.session_state.result = None

# ------------------ Evaluate Button ------------------
if st.button("ğŸš€ Evaluate Proposal", disabled=(file is None)):
    with st.spinner("ğŸ§  Analyzing proposal semantics using transformer embeddings..."):
        time.sleep(1)

    with st.spinner("ğŸ“Š Running ML evaluation model (Random Forest Regressor)..."):
        time.sleep(1)

    with st.spinner("âœï¸ Generating AI-written evaluation report using GenAI..."):
        time.sleep(1)

    response = requests.post(
        "http://localhost:8000/submit/",
        files={"file": file},
        data={"budget": budget}
    )

    if response.status_code == 200:
        st.session_state.result = response.json()
    else:
        st.error("âŒ Evaluation failed. Please try again.")

# ------------------ Display Results ------------------
if st.session_state.result:
    data = st.session_state.result

    st.divider()
    st.subheader("ğŸ“Š AI Evaluation Summary")

    col1, col2 = st.columns(2)

    with col1:
        st.metric(
            label="Final AI Score",
            value=f"{data['final_score']:.2f} / 100"
        )
        st.progress(min(data["final_score"] / 100, 1.0))

    with col2:
        if "confidence" in data:
            st.metric("AI Confidence Level", f"{data['confidence']} %")

    st.success(f"ğŸ“ Decision: **{data['decision']}**")

    # ------------------ Explainable AI ------------------
    st.divider()
    st.subheader("ğŸ§  Explainable AI Insights")

    for line in data.get("explanation", []):
        st.write("â€¢", line)

    # ------------------ Feature Importance Radar ------------------
    if "feature_importance" in data:
        st.divider()
        st.subheader("ğŸ“Š ML Feature Importance (Explainable AI)")

        fi = data["feature_importance"]
        labels = list(fi.keys())
        values = list(fi.values())

        fig = go.Figure(
            data=[
                go.Scatterpolar(
                    r=values + [values[0]],
                    theta=labels + [labels[0]],
                    fill="toself",
                    name="Feature Importance"
                )
            ]
        )

        fig.update_layout(
            polar=dict(
                radialaxis=dict(
                    visible=True,
                    range=[0, max(values) if max(values) > 0 else 1]
                )
            ),
            showlegend=False
        )

        st.plotly_chart(fig, use_container_width=True)

    # ------------------ GenAI Narrative ------------------
    if "ai_report_text" in data:
        st.divider()
        st.subheader("ğŸ¤– AI Evaluation Narrative (Generated by LLM)")
        st.write(data["ai_report_text"])

    # ------------------ PDF Report ------------------
    st.divider()
    st.subheader("ğŸ“„ Evaluation Report")

    st.markdown(
        f"[â¬‡ï¸ Download AI Evaluation PDF]({data['report_url']})",
        unsafe_allow_html=True
    )
